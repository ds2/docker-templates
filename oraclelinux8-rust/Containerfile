FROM oraclelinux:8.6

# prepare image
RUN dnf update -y
RUN dnf -y install rpmdevtools rpm-build rpm-sign gcc openssl-devel pkg-config zsh git
RUN adduser -c "RPM build user for Rust stuff" -s /bin/zsh -m rusty

# setup user environment (we do not run as root!!)
USER rusty
SHELL [ "/bin/zsh" ]
WORKDIR /tmp
ENV CARGO_BUILD_TARGET='x86_64-unknown-linux-gnu'

# install rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh  -s -- --profile minimal -y
RUN source ~/.cargo/env; cargo version

# prepare runs
RUN mv ~/.cargo/env ~/.cargo/env.orig; echo "" >~/.cargo/env
COPY entrypoint.sh /entrypoint.sh
ENTRYPOINT [ "/entrypoint.sh" ]
WORKDIR /work
CMD [ "/bin/zsh" ]
